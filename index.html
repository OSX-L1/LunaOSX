<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ใบเสนอราคา</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- ส่วนอื่นๆ ของ HTML -->

    <!-- ปุ่มดาวน์โหลด PDF -->
    <button id="pdf-download-btn">ดาวน์โหลด PDF</button>

    <!-- modal preview PDF -->
    <div id="pdf-preview-modal" style="display: none;">
        <!-- เนื้อหาของ modal -->
    </div>

    <!-- ฟอนต์ Sarabun ต้องถูกโหลดก่อนใช้งาน jsPDF -->
    <script>
        // สมมุติว่ามีการโหลดฟอนต์แบบ Base64 ไว้ใน window.Sarabun_Regular_normal
        // ตัวอย่างเท่านั้น: ควรโหลดจริงจาก font file ที่แปลงเป็น base64 ด้วย jsPDF
        window.Sarabun_Regular_normal = '...Base64 encoded TTF file...';
    </script>

    <!-- โค้ดที่รวมแล้วจาก Fix Pdf Download -->
    <script>
    function setupPdfDownloadButton() {
        const pdfDownloadBtn = document.getElementById('pdf-download-btn');
        if (!pdfDownloadBtn) {
            console.warn("ไม่พบปุ่ม pdf-download-btn ใน DOM");
            return;
        }

        pdfDownloadBtn.addEventListener('click', () => {
            if (window.currentPdfData) {
                generatePdf(
                    window.currentPdfData.title,
                    window.currentPdfData.columns,
                    window.currentPdfData.body,
                    window.currentPdfData.total,
                    window.currentPdfData.filename,
                    window.currentPdfData.extraInfo
                );
            } else {
                alert("ไม่พบข้อมูลสำหรับสร้าง PDF");
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const previewModal = document.getElementById('pdf-preview-modal');
        if (previewModal) {
            const observer = new MutationObserver(() => {
                if (previewModal.style.display === 'flex') {
                    setupPdfDownloadButton();
                }
            });
            observer.observe(previewModal, { attributes: true, attributeFilter: ['style'] });
        }
    });
    </script>

    <script>
    function generatePdf(title, columns, body, total, filename, extraInfo = []) {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            if (!window.Sarabun_Regular_normal) {
                alert("ไม่พบฟอนต์ภาษาไทย กรุณาตรวจสอบการโหลดฟอนต์");
                return;
            }

            doc.addFileToVFS("Sarabun-Regular-normal.ttf", window.Sarabun_Regular_normal);
            doc.addFont("Sarabun-Regular-normal.ttf", "Sarabun-Regular", "normal");
            doc.setFont("Sarabun-Regular", "normal");

            doc.setFontSize(18);
            doc.text(title, 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.text('Blinds Design Co., Ltd. (ตัวอย่าง)', 20, 30);
            const today = new Date().toLocaleDateString('th-TH', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            doc.text(`วันที่: ${today}`, 200, 30, { align: 'right' });

            let startY = 40;
            if (extraInfo.length > 0) {
                doc.setFontSize(12);
                extraInfo.forEach(info => {
                    doc.text(`${info.label}: ${info.value || '-'}`, 20, startY);
                    startY += 7;
                });
            }

            doc.autoTable({
                head: [columns],
                body: body,
                startY: startY + 5,
                theme: 'grid',
                headStyles: {
                    font: "Sarabun-Regular",
                    fontStyle: 'bold',
                    fillColor: [22, 160, 133],
                    textColor: 255
                },
                styles: {
                    font: "Sarabun-Regular",
                    fontStyle: 'normal'
                }
            });

            let finalY = doc.lastAutoTable.finalY;
            doc.setFontSize(12);
            doc.text('ยอดรวมสุทธิ:', 140, finalY + 10);
            doc.text(`THB ${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`, 200, finalY + 10, { align: 'right' });

            doc.save(filename);
        } catch (e) {
            console.error("PDF Generation Error: ", e);
            alert("เกิดข้อผิดพลาดในการสร้างไฟล์ PDF: " + e.message);
        }
    }
    </script>
</body>
</html>
